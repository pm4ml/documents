= Configuring user access and user accounts in Keycloak

Before you can start using Keycloak, you must have an admin account created for you. Once you have an admin account, you are ready to log in to the Admin Console of Keycloak.

== Realms

In the case of an on-premise deployment, {product-name} comes with a *payment manager* realm configured. A realm can be thought of as an isolated domain, in this case, that domain is the {product-name} application. Anything within the *payment manager* realm relates to the {product-name} instance.

In the case of a SaaS cloud deployment, there could be a single Keycloak instance with one realm created for each DFSP. Alternatively, there can be one realm for all DFSPs, with access to the various {product-name} instances within that realm being tightly controlled.

*<screenshot about Realm > General or Login>*

The *payment manager* realm comes with pre-configured settings out-of-the-box. You can find these settings under the *Realm Settings* menu item, displayed in the left-hand navigation pane. On clicking *Realm Settings*, various tabs are displayed in the right-hand pane. Some of the settings of the *General* and *Login* tabs, related to users are highlighted in the table below.

.Realm Settings
[width="100%",options="header", cols="2,5"]
|====================
| Tab |  Setting
| *General* |  *Name:* pm4ml
|  |  *Enabled: ON* +
 +
This is required because a realm can only be accessed if it is enabled.
|  | *Display name:* Payment Manager for Mojaloop +
 +
The name specified here is the name that is displayed on the Keycloak sign-in page when the user logs in to {product-name}.
|  |  *User-Managed Access: OFF*
|  |  *Endpoints:* *OpenID Endpoint Configuration* and *SAML 2.0 Identity Provider Metadata*
| **Login** | *User registration: OFF* +
 +
This is required so that {product-name} cannot create an account for themselves, and user accounts are always created by an admin person.
|  | *Edit username: OFF*
|  | https://www.keycloak.org/docs/latest/server_admin/index.html#forgot-password[*Forgot password: ON*] +
 +
When enabled, users are able to reset their credentials if they forget their password or lose their OTP generator. 
|  | https://www.keycloak.org/docs/latest/server_admin/index.html#remember-me[*Remember Me: OFF*] +
 +
When disabled, if a logged in user closes their browser, their session is destroyed and they will have to log in again.
|  | *Verify email: OFF* +
 +
When disabled, the user will not get a verification on registering the user.
|  | *Login with email: ON* +
 +
When enabled, the user can log in using their email address.
|  | https://www.keycloak.org/docs/latest/server_admin/index.html#_ssl_modes[**Require SSL: external requests**] +
 +
Keycloak requires a secure connection when accessing {product-name} from a non-private IP address.
|====================

== Clients

https://www.keycloak.org/docs/latest/server_admin/index.html#_clients[Clients] are entities that can request the authentication of a user. For Keycloak, the {product-name} application is one such entity.

The {product-name} user interface (**pm4ml-customer-ui**) is registered as a client to the {product-name} realm. On clicking **pm4ml-customer-ui**, the settings associated with it are displayed. Some settings are highlighted below.

*<screenshot about Clients > pm4ml-customer-ui Settings or Credentials>*

.Clients
[width="100%",options="header", cols="2,5"]
|====================
| Tab |  Setting
| *Settings* | *Root URL:* Specify the URL of the front end here.
| *Credentials* | *Client Athenticator: Client id and Secret* +
 +
This setting is required so that the {product-name} backend API can identify itself securely to Keycloak. The secret is automatically generated for you and the *Regenerate Secret* button allows you to recreate this secret if you want or need to. +
 +
*NOTE:* You get a new client secret every time you restart Keycloak (Keycloak refreshes all its keys if the database that holds the keys loses its state).
|====================

== Roles

Roles identify a type or category of user. The {product-name} realm comes with the following default roles:

* *offline_access* (comes with Keycloak out-of-the-box, enables the usage of https://www.keycloak.org/docs/latest/server_admin/index.html#_offline-access[offline tokens])
* *uma_authorization* (comes with Keycloak out-of-the-box, UMA stands for https://www.keycloak.org/docs/latest/authorization_services/#_service_user_managed_access[User-Managed Access])
* *read-all* 
* *write-all*

*<screenshot about Roles>*

The logic of the roles is created in {product-name}, through https://github.com/modusintegration/mojaloop-payment-manager-experience-api[the Experience API]:

* In `src`, there is a file called `rolePermissionMap.json`. The configuration defined in this file maps Keycloak roles to internal {product-name} permissions.
* In `src`, there is a file called `handler.js`, where you can define what action can or cannot be performed if a user has or does not have a particular {product-name} permission.

You can define roles and the permissions within them and how those relate to the functions that a user can perform via the Experience API, allowing for flexible roles and permissions handling.

In addition to allowing or denying access to a particular function, you can also do filtering based on roles. Take the following example. Let's suppose that a DFSP wants one of their Support staff to only be able to search for transfers that are errors. It is possible to make a new role just for that DFSP in their Keycloak, and map that role to the respective permissions.

== Users

This section looks at how to add users, how to configure user accounts, and how to view user details using the https://www.keycloak.org/docs/latest/server_admin/index.html#user-management[*Users*] menu in Keycloak.

=== Creating users

A new deployment of {product-name} comes with no users at all. To add a user, complete the following steps:

. Click *Users* in the left-hand navigation pane.
. Click the *Add user* button on the right. The *Add user* page comes up. +
image:.png[] *<screenshot: starter page for Users>*
. Fill in the following fields:

* Username
* Email
* First Name
* Last Name
* User Enabled: ON
* Email Verified: ON

. Click **Save**. On clicking **Save**, the user is created. You will see the *ID* field getting populated. *<screenshot: new user is saved>*
. Create a password for the user:
.. Click the **Credentials** tab.
.. Enter a password in the *Password* field.
.. Re-enter the password in the *Password Confirmation* field.
.. If it is not a temporary password, set *Temporary* to **OFF**. *<screenshot: Credentials tab>*
.. Click **Set Password**.
. Set roles for the user:
.. Click the *Role Mappings* tab. By default, users in the realm get the following roles: **read_all**, **offline_access**, and **uma_authorization**. Decide wheher you want to add the *write-all* role too.
.. If you wish to add the *write-all* role, click the role in the *Available Roles* box and click *Add selected*. *<screenshot: Roles tab>*
. Optionally, you can add a user to a group. You can do this on the https://www.keycloak.org/docs/latest/server_admin/index.html#groups[*Group*] tab. *<screenshot: Group tab>*

=== Viewing user details 

To view details of a particular user:

. Click *Users* in the left-hand navigation pane. The *Lookup* page is displayed. 
. Enter a keyword in the *Search* field and click the magnifier icon, or click **View all users**. The list of search results/users is displayed.
. To view details of a particular user, click the *ID* of the user that your are interested in.

=== View the open sessions of a user

To view what sessions a particular user has open:

. Click *Users* in the left-hand navigation pane. The *Lookup* page is displayed. 
. Enter a keyword in the *Search* field and click the magnifier icon, or click **View all users**. The list of search results/users is displayed.
. Click the *ID* of the user that your are interested in.
. Click the *Sessions* tab. The tab displays the following information:

* IP Address
* when the session started
* when {product-name} was last accessed by the user
* which client (application) the user is logged in to

You can also choose to log out the user of the session using the *Logout* button.

*<screenshot>*

=== Resetting a user's one-time passcode (OTP)

By default, two-factor authentication is set for a new user account. This means that the first time the user logs in, they are prompted to scan a QR code with Google Authenticator on their phone, and then sign in to {product-name} with a one-time passcode.

If the user ever loses their record in their Google Authenticator, then the user's OTP must be reset following these steps:

. Click *Users* in the left-hand navigation pane.
. Click the *Credentials* tab. 
. Go to *Manage Credentials* and delete the otp record.

The next time the user tries to sign in, they have to scan the QR code again.

=== Resetting a user's password

When a user forgets their password, you can reset their password following these steps:

. Click *Users* in the left-hand navigation pane.
. Click the *Credentials* tab. 
. Go to *Reset Password* and set a new password:
.. Enter a password in the *Password* field.
.. Re-enter the password in the *Password Confirmation* field.
.. Set the password as a temporary password that the user will be prompted to change on first use. Set *Temporary* to **ON**. *<screenshot: Credentials tab>*
.. Click **Reset Password**.

== Authentication

The https://www.keycloak.org/docs/latest/server_admin/index.html#authentication[*Authentication*] menu allows you to configure authentication details for the user account, such as two-factor authentication, password and one-time passcode (OTP) policies, actions that the user must do or cannot do when they first log in.

=== Two-factor authentication

By default, {product-name} comes with two-factor authentication set. This setting is configured via the *Flows* tab > *Browser - Conditional OTP* option, which must be set to *REQUIRED* for two-factor authentication to take place on user login.

NOTE: To ensure Google Authenticator based two-factor authentication is supported, on the *OTP Policy* tab, leave *OTP Hash Algorithm* as **SHA1**.

=== Required actions

You can choose to require the user to perform certain actions before they are allowed to log in. These actions are called required actions. Once a required action is completed, the user will not have to perform the action again. 

For detailed information on required actions, see section https://www.keycloak.org/docs/latest/server_admin/index.html#required-actions[Required Actions] in the *_Keycloak Server Administration Guide_*.

=== Password policy

To set a password policy, go to the *Password Policy* tab and click *Add policy...* on the right-hand side. The drop-down menu has all the aspects of a password policcy that you can control (for example, expiry, minimum length, use of special characters, and so on). Click any of the options to start configuring details.

For detailed information on password policies, see section https://www.keycloak.org/docs/latest/server_admin/index.html#_password-policies[Password Policies] in the *_Keycloak Server Administration Guide_*.

=== OTP policy

To configure details of the policy for how OTPs are validated, go to the *OTP Policy* tab.

NOTE: To ensure Google Authenticator based two-factor authentication is supported, on the *OTP Policy* tab, leave *OTP Hash Algorithm* as **SHA1**.

For detailed information on OTP policies, see section https://www.keycloak.org/docs/latest/server_admin/index.html#otp-policies[OTP Policies] in the *_Keycloak Server Administration Guide_*.

== Sessions

The *Sessions* menu allows you to view all active {product-name} sessions:

. Click *Sessions* in the left-hand navigation pane. The *Realm Sessions* tab displays the clients configured in Keycloak. In our case, this will be the *pm4ml-customer-ui* client, that is the {product-name} application.
. Click the client. You are taken to the *Clients* menu > *Sessions* tab, where you can view a list of all users with active sessions.

*<screenshot>*

== User Federation

When {product-name} is deployed on-premise, the DFSP might have a Microsoft network that uses Active Directory (AD) for user management. Choosing the *kerberos* option from the *Add provider...* drop-down list on the *User Federation* page, the DFSP can tell Keycloak to use the DFSP's Active Directory database, and Keycloak will treat users in the AD database as if they belonged to the Keycloak database as well. Every time there is a login request, Keycloak forwards the request to the AD database. 

Similarly, if the DFSP has an LDAP user database, it is possible to link up Keycloak with that database, using the *ldap* option.

For further information, see section https://www.keycloak.org/docs/latest/server_admin/index.html#_user-storage-federation[User Storage Federation] in the *_Keycloak Server Administration Guide_*.

== Identity Providers

It is possible to set up {product-name} in such a way that users can authenticate with external OpenID Connect or SAML Identity Providers. For example, {product-name} users could log in to {product-name} using their Google account. You can configure that via the *Identity Providers* menu on the left-hand side.

For detailed information, see section https://www.keycloak.org/docs/latest/server_admin/index.html#_identity_broker[Identity Brokering] in the *_Keycloak Server Administration Guide_*.
